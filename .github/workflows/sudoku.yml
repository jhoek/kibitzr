name: sudoku

on:
  schedule:
    - cron: "0 8 * * *"
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - name: Install pup
        shell: bash
        run: |
          go get github.com/ericchiang/pup
          export GOROOT=/usr/bin/go
          cd ~/go/bin
          sudo cp pup /usr/bin
          pup --version

      - name: Install required PowerShell modules
        shell: pwsh
        run: |
          Set-PSRepository PSGallery -InstallationPolicy Trusted
          Install-Module UncommonSense.AirTable, UncommonSense.Nrc, UncommonSense.Pushover, Test-InKibitzrHistory -Scope CurrentUser

      - name: Send notification
        shell: pwsh
        env:
          AIRTABLE_APIKEY: ${{ secrets.AIRTABLE_APIKEY}}
          AIRTABLE_BASE: ${{ secrets.AIRTABLE_BASE_SUDOKU}}
          PUSHOVER_APP: ${{ secrets.PUSHOVER_APP_SUDOKU}}
          PUSHOVER_RECIPIENT: ${{secrets.PUSHOVER_RECIP_JUSTME}}
        run: |
          Get-Sudoku
          | Where-Object { -not (Test-InKibitzrHistory -ApiKey $env:AIRTABLE_APIKEY -BaseName $env:AIRTABLE_BASE -Table History -Url $_.Url -Date $_.Date -Title $_.Title -Body $_.Body)}
          | ForEach-Object {
            Send-PushoverNotification `
              -ApplicationToken $env:PUSHOVER_APP `
              -Recipient $env:PUSHOVER_RECIPIENT `
              -Message $_.Body `
              -Title ('Sudoku ({0:dddd d MMMM yyyy})' -f $_.Date) `
              -Verbose
          }
