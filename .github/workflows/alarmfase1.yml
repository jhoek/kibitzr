name: alarmfase1

on:
  push:
    branches:
      - master
  # schedule:
  #   - cron: "*/5 * * * *"
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - name: Install Pup
        shell: bash
        run: go get github.com/ericchiang/pup

      - name: Install Pushover modules
        shell: pwsh
        run: |
          $ProgressPreference = 'SilentlyContinue'
          Set-PSRepository PSGallery -InstallationPolicy Trusted
          Install-Module UncommonSense.Pushover, UncommonSense.P2000

      - name: Find new entries
        shell: pwsh
        run: |
          1109, 3286, 1432 | ForEach-Object {
            Get-P2000Entry -PostCode $_ `
            | Where-Object Priority -In 'P1', 'A1' `
            | Where-Object DateTime -GT (Get-Date).AddMinutes(-3) `
            | Select-Object -First 10 `
            | ForEach-Object {
                Send-PushoverNotification `
                    -ApplicationToken aoiqq9zfsf32aodh55zoyg9rc3zhrh `
                    -Recipient u65ckN1X5uHueh7abnWukQ2owNdhAp `
                    -Title $_.Title `
                    -Message $_.Original `
                    -SupplementaryUrl $_.Link
            }
          }
